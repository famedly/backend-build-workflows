name: Rust workflow

on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        default: ubuntu-latest-16core

# Environment variables for all jobs.
env:
  CARGO_TERM_COLOR: always
  ADDITIONAL_PACKAGES: ""

# Defined CI jobs.
jobs:
  check:
    runs-on: ubuntu-latest
    container: ghcr.io/famedly/rust-container:nightly
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        path: head

    - uses: famedly/backend-build-workflows/.github/actions/rust-prepare@main
      with:
        gitlab_ssh: ${{ secrets.CI_SSH_PRIVATE_KEY}}
        gitlab_user: ${{ secrets.GITLAB_USER }}
        gitlab_pass: ${{ secrets.GITLAB_PASS }}

    - name: Caching
      uses: Swatinem/rust-cache@b8a6852b4f997182bdea832df3f9e153038b5191
      with:
        workspaces: "head -> target"
        cache-on-failure: true

    - name: Rustfmt
      shell: bash
      working-directory: head
      run: cargo +${NIGHTLY_VERSION} fmt -- --check

    - name: Clippy
      working-directory: head
      shell: bash
      run: cargo clippy --workspace --all-targets -- -D warnings

    - name: Udeps
      shell: bash
      working-directory: head
      run: cargo +${NIGHTLY_VERSION} udeps

    - name: Typos
      shell: bash
      working-directory: head
      run: typos

  report-coverage:
    runs-on: ubuntu-latest
    container: ghcr.io/famedly/rust-container:nightly
    permissions:
      # This is set explictly to allow comments in response to
      # Dependabot PRs which have a read-only GITHUB_TOKEN by default
      pull-requests: write
      issues: write
      contents: read
    needs: [test]
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        path: head

    - uses: actions/download-artifact@v4
      with:
        name: coverage-data
        path: head

    - uses: zgosalvez/github-actions-report-lcov@fea161ae6d85807479ea109d42259c9165558a64
      with:
        working-directory: ./head/
        coverage-files: head/lcov.info
        artifact-name: code-coverage-report
        github-token: ${{ secrets.GITHUB_TOKEN }}
        update-comment: true

  publish-coverage:
    runs-on: ubuntu-latest
    needs: report-coverage

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Publish coverage page
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: code-coverage-report

  test:
    runs-on: ${{ inputs.runs-on }}
    container: ghcr.io/famedly/rust-container:nightly
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        path: head

    - uses: famedly/backend-build-workflows/.github/actions/rust-prepare@main
      with:
        gitlab_ssh: ${{ secrets.CI_SSH_PRIVATE_KEY}}
        gitlab_user: ${{ secrets.GITLAB_USER }}
        gitlab_pass: ${{ secrets.GITLAB_PASS }}

    - name: Caching
      uses: Swatinem/rust-cache@b8a6852b4f997182bdea832df3f9e153038b5191
      with:
        workspaces: "head -> target"
        cache-on-failure: true
        # Turn this on if your test isn't running in a container
        # cache-all-crates: true

    - name: Test
      timeout-minutes: 20
      shell: bash
      working-directory: head
      run: cargo llvm-cov --no-report nextest --no-fail-fast --workspace

    - name: Doc-test
      shell: bash
      working-directory: head
      # Nextest doesn't support doctests, so we need to run this separately
      run: cargo +${NIGHTLY_VERSION} llvm-cov --no-report --doc --workspace --verbose

    - name: Merge coverage
      shell: bash
      working-directory: head
      run: |
        cargo +${NIGHTLY_VERSION} llvm-cov report --doctests --lcov --output-path lcov.info
        sed "s|$PWD/||g" -i lcov.info

    - uses: actions/upload-artifact@v4
      with:
        name: coverage-data
        path: head/lcov.info
